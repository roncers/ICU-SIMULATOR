docs <- doctors
enfs <- nurses
# 3 de 8h a 16h, 4 de 16h a 24h y 2 de 0h a 8h
horario_doctores <- schedule(c(160, 320, 480), c(docs, docs, docs), period=480)
# 6 de 8h a 16h, 8 de 16h a 24h y 4 de 0h a 8h
horario_enfermeras <- schedule(c(160, 320, 480), c(enfs, enfs, enfs), period=480)
## Agregar recursos al modelo
modelo %>%
add_resource("Sala de espera", capacity = 100) %>%
add_resource("Camas", capacity = beds) %>%
add_resource("Sala de descansos", capacity = 4) %>%
add_resource("Doctores", horario_doctores) %>%
add_resource("Enfermeras", horario_enfermeras)
## Definir la trayectoria de los doctores
paciente <-
trajectory("trayectoria de un paciente") %>%
log_("Llegada") %>%
set_attribute("Estado_vital", -11) %>% ## llegada
## Programar un determinado tiempo durante el que si un paciente se queda esperando fallece
### Tiempo que sigue una exponencial
renege_in(function(){convierte(rexp(n=1,rate=1/100))},
out = trajectory("Muerte_desatendidos") %>%
set_attribute("Estado_vital", -1) %>%
log_("Paciente se muere por falta de espacio en la UCI")) %>%
seize("Camas") %>%
## Abortar el evento de muerte por no ser atendido
renege_abort() %>%
set_attribute("Estado_vital", -10) %>% ## en cama
log_("Inicio estancia en cama paciente") %>%
log_("Doctor empieza a determinar el tratamiento del paciente") %>%
renege_in(function(){convierte(rnorm(1,8,2))},
out = trajectory("Muerte_desatendidos") %>%
set_attribute("Estado_vital", -3) %>%
log_("Paciente se muere por falta de atención")) %>%
seize("Doctores") %>%
renege_abort() %>%
### doctores atienden siguiendo normal
timeout(convierte(rnorm(1,3))) %>%
log_("Doctor termina de determinar el tratamiento del paciente") %>%
# Es posible que al llegar el paciente necesite ser operado
branch(
###50%
function() {ifelse(rpois(1,1/2) >= 1, 2, 1)}, continue=c(TRUE, TRUE),
trajectory("Paciente requiere operación") %>%
set_attribute("Estado_vital", 3) %>% ## intervención quirúrgica
renege_in(function(){convierte(rnorm(1,15,2))},
out = trajectory("Muerte_desatendidos") %>%
set_attribute("Estado_vital", -3) %>%
log_("Paciente se muere por falta de atención")) %>%
seize("Enfermeras", amount = 2) %>%  # Camino 1: Paciente es operado
renege_abort() %>%
### Tiempo de operación dado por una normal
log_("Inicio operación") %>%
timeout(convierte(rnorm(1, mean = 12, sd = 1))) %>%
log_("Fin operación") %>%
release("Enfermeras",amount = 2) %>%
log_("Paciente operado") %>%
branch(
function() {ifelse(rpois(1,1/60) >= 1, 1, 2)}, continue=c(FALSE, TRUE),
trajectory("Muerte_operacion") %>%
### exponencial de tiempo antes de morir
timeout(convierte(rexp(n=1,rate=1/4))) %>%
set_attribute("Estado_vital", -2) %>%
log_("Paciente fallece por la operación") %>%
release_all() %>%
log_("Fin estancia en cama paciente"),
trajectory("Paciente sobrevive a la operación") %>%
set_attribute("Estado_vital", 1) %>% ## cuidados críticos
log_("Paciente sobrevive a la operación")
),
trajectory("Paciente no requiere operación") %>%  # Camino 2: Paciente no es operado
set_attribute("Estado_vital", 1) %>% ## cuidados críticos
log_("Paciente no operado")
) %>%
release("Doctores") %>%
### necesita cuidados críticos, cosa normal porque acaba de entrar en la UCI
branch(
function() {get_attribute(modelo, "Estado_vital")}, continue=c(TRUE,TRUE,TRUE,TRUE,TRUE), # Si hay 3 o menos doctores disponibles
trajectory("Cuidados_críticos") %>%
log_("Paciente empieza a recibir cuidados críticos") %>%
renege_in(function(){convierte(rnorm(n=1, mean = 8, sd = 2))},
out = trajectory("Muerte_desatendidos") %>%
set_attribute("Estado_vital", -3) %>%
log_("Paciente se muere por falta de atención")) %>%
seize("Doctores") %>%
seize("Enfermeras") %>%
## Abortar el evento de muerte por no ser atendido
renege_abort() %>%
timeout(convierte(rnorm(1, mean = 10, sd = 6))) %>%
branch(
### Siguiente estado
function() {cuidados_criticos()}, continue=c(TRUE, TRUE,TRUE, FALSE),
trajectory("Paciente continua en estado crítico") %>%
log_("Paciente sigue crítico"),
trajectory("Paciente mejora su estado") %>%
log_("Paciente mejora su estado_vital") %>%
set_attribute("Estado_vital", 2),
trajectory("Paciente requiere operación") %>%
log_("Paciente requiere operación") %>%
set_attribute("Estado_vital", 3),
trajectory("Paciente fallece") %>%
log_("Paciente en estado crítico fallece") %>%
release("Doctores") %>%
release("Enfermeras") %>%
release("Camas") %>%
set_attribute("Estado_vital", -4) %>%
log_("Fin estancia en cama paciente")
) %>%
release("Doctores") %>%
release("Enfermeras") %>%
log_("Paciente termina de recibir cuidados críticos") %>%
timeout(convierte(rnorm(1, mean = 10, sd = 1))) %>%
rollback("bucle_pacientes", 10000),
trajectory("Cuidados_especiales") %>%
log_("Paciente empieza cuidados especiales") %>%
set_attribute("tiempo_espera_inicio", function(){return(now(modelo))}) %>%
seize("Enfermeras", amount = 2) %>%
set_attribute("tiempo_espera", function(){return(now(modelo) - get_attribute(modelo, "tiempo_espera_inicio"))}) %>%
timeout(convierte(rnorm(1, mean = 9, sd = 5))) %>%
branch(
function() {cuidados_paciente(get_attribute(modelo, "tiempo_espera"), 5, 2)}, continue=c(TRUE, TRUE, TRUE),
trajectory("Paciente continua en cuidados especiales") %>%
log_("Paciente sigue crítico"),
trajectory("Paciente empeora a estado crítico") %>%
log_("Paciente vuelve a estado crítico") %>%
set_attribute("Estado_vital", 1),
trajectory("Paciente mejora a cuidados básicos") %>%
log_("Paciente mejora a cuidados básicos") %>%
set_attribute("Estado_vital", 4)
) %>%
release("Enfermeras", amount = 2) %>%
timeout(convierte(rnorm(1, mean = 20, sd = 5))) %>%
rollback("bucle_pacientes", 10000),
trajectory("Intervención_quirúrgica") %>%
log_("Paciente empieza intervención quirúrgica") %>%
## Habría que comprobar que hay enfermeras
renege_in(function(){convierte(rnorm(n=1, mean = 7, sd = 2))},
out = trajectory("Muerte_desatendidos") %>%
set_attribute("Estado_vital", -3) %>%
log_("Paciente se muere por falta de atención")) %>%
seize("Doctores") %>%
seize("Enfermeras", amount = 2) %>%
renege_abort() %>%
### Tiempo de operación dado por una normal
log_("Inicio operación") %>%
timeout(convierte(rnorm(1, mean = 12, sd = 1))) %>%
log_("Fin operación") %>%
release("Enfermeras", amount = 2) %>%
release("Doctores") %>%
log_("Paciente operado") %>%
branch(
function() {ifelse(rpois(1,1/60) >= 1, 1, 2)}, continue=c(FALSE, TRUE),
trajectory("Muerte_operacion") %>%
### exponencial de tiempo antes de morir
timeout(convierte(rexp(n=1,rate=1/4))) %>%
set_attribute("Estado_vital", -2) %>%
log_("Paciente fallece por la operación") %>%
release("Camas") %>%
log_("Fin estancia en cama paciente"),
trajectory("Paciente sobrevive a la operación") %>%
log_("Paciente sobrevive a la operación")
) %>%
set_attribute("Estado_vital", 1) %>% ## El paciente vuelve a estar otra vez crítico después de la operación
rollback("bucle_pacientes", 10000),
### Se producen las visitas y las altas de los pacientes
trajectory("Cuidados_básicos") %>%
log_("Paciente empieza cuidados básicos") %>%
set_attribute("tiempo_espera_inicio", function(){return(now(modelo))}) %>%
seize("Enfermeras") %>%
set_attribute("tiempo_espera", function() {return(now(modelo)- get_attribute(modelo, "tiempo_espera_inicio"))}) %>%
timeout(convierte(rnorm(1, mean = 5, sd = 1))) %>%
branch(
### sigue básico 75% mejora 10% operación 10% fallece 5%
function() {cuidados_paciente(get_attribute(modelo, "tiempo_espera"), 10, 1)}, continue=c(TRUE, TRUE, TRUE),
trajectory("Paciente continua en cuidados básicos") %>%
log_("Paciente sigue en cuidados básicos") %>%
### inicio visitas, si tiene familiares esperando puede recibir visitas
branch(
function() {visitas(now(modelo))}, continue=c(TRUE, TRUE),
trajectory("Paciente recibe visita") %>%
set_attribute("recibe_visita", 1) %>%
timeout(convierte(rnorm(1,10,2))) %>%
set_attribute("recibe_visita", 0),
trajectory("Paciente no recibe visita") %>%
seize("Enfermeras") %>%
timeout(convierte(rnorm(1,5,1))) %>%
release("Enfermeras")
),
### fin visitas
trajectory("Paciente empeora a cuidados especiales") %>%
log_("Paciente vuelve a cuidados especiales") %>%
set_attribute("Estado_vital", 2),
trajectory("Paciente mejora al estado de extracción") %>%
log_("Paciente recibe el alta de la UCI") %>%
set_attribute("Estado_vital", 5)
) %>%
release("Enfermeras") %>%
timeout(convierte(rnorm(1, mean = 25, sd = 5))) %>%
rollback("bucle_pacientes", 10000),
trajectory("Extracción") %>%
log_("Paciente estable y va a ser sacado de la UCI"),
tag = "bucle_pacientes"
)  %>%
## Cada cierto tiempo hay que alimentar a los pacientes
## Es posible que un paciente requiera de una intervención quirúrgica
## Un paciente debe ser tratado de vez en cuando, si este es olvidado su estado vital empeorará
## Una vez el paciente este en buen estado vital podrá recibir visitas
release("Camas") %>%
set_attribute("Curado", 1) %>%
log_("Fin estancia en cama paciente")
descansos_docs <-
trajectory("trayectoria descansos doctores") %>%
timeout(convierte(rnorm(1, mean = 5, sd = 2))) %>%
log_("Inicio descansos") %>%
seize("Doctores") %>%
seize("Sala de descansos") %>%
set_attribute("Doctor_descansa", 1) %>%
timeout(convierte(rnorm(1, mean = 8, sd = 3))) %>%
release("Sala de descansos") %>%
release("Doctores") %>%
set_attribute("Doctor_descansa", 0) %>%
log_("Fin descanso doctores")
descansos_enfs <-
trajectory("trayectoria descansos enfermeras") %>%
timeout(convierte(rnorm(1, mean = 5, sd = 2))) %>%
log_("Inicio descanso enfermeras") %>%
seize("Enfermeras") %>%
seize("Sala de descansos") %>%
set_attribute("Enfermera_descansa", 1) %>%
timeout(convierte(rnorm(1, mean = 8, sd = 3))) %>%
release("Sala de descansos") %>%
release("Enfermeras") %>%
set_attribute("Enfermera_descansa", 0) %>%
log_("Fin descanso enfermeras")
trayectoria_visitas <-
trajectory("trayectoria de las visitas") %>%
log_("Fin descanso personal")
## Agregar el generador de los pacientes
modelo %>%
### Pacientes llegan siguiendo una distribución normal
add_generator("Paciente", paciente, function(){convierte(rnorm(1,80,20))}, mon=2) %>%
add_generator("Descanso_doctor", descansos_docs, function(){convierte(rnorm(1,40,5))}, mon=2) %>%
add_generator("Descanso_enfermera", descansos_enfs, function(){convierte(rnorm(1,40,5))}, mon=2)
## Correr el modelo
modelo %>%
run(until = 480 * day_number)
# recursos <- get_mon_resources(modelo)
# print(get_mon_attributes(modelo))
# plot(recursos, metric="usage", items = c("queue", "server"), steps=TRUE)
# plot(recursos, metric="utilization",c("Sala de espera", "Camas"))
######################RECOLECCIÓN DE DATOS
recursos <- get_mon_resources(modelo)
curados <- modelo %>%
get_mon_attributes() %>%
filter(key == "Curado" & value == 1)
muertes_1 <- modelo %>%
get_mon_attributes() %>%
filter(key == "Estado_vital" & value == -1) # Camas insuficientes
muertes_2 <- modelo %>%
get_mon_attributes() %>%
filter(key == "Estado_vital" & value == -2) # Operación
muertes_3 <- modelo %>%
get_mon_attributes() %>%
filter(key == "Estado_vital" & value == -3) # Falta atención
muertes_4 <- modelo %>%
get_mon_attributes() %>%
filter(key == "Estado_vital" & value == -4) # Estado crítico
visitas <- modelo %>%
get_mon_attributes() %>%
filter(key == "recibe_visita" & value == 1)
atendidos <- modelo %>%
get_mon_attributes() %>%
filter(key == "Estado_vital" & value == -10)
# Obtener los tiempos de actividad de todos los pacientes curados
arrivals <- modelo %>%
get_mon_arrivals()
atributos <- modelo %>%
get_mon_attributes()
#
# # Unir los datos de pacientes curados con sus tiempos de actividad
curados_activity_time <- curados %>%
select(name) %>%
distinct() %>%
inner_join(arrivals, by = c("name" = "name"))
# Calcular la media del tiempo de actividad de los pacientes curados
if (nrow(curados_activity_time) > 0) {
mean_activity_time <- mean(curados_activity_time$activity_time)
} else {
mean_activity_time <- 0
}
# print(mean_activity_time) # tiempo de estancia curados
# print(nrow(atendidos))
# print(nrow(curados)) # Curados
# print(nrow(muertes_1) + nrow(muertes_2) + nrow(muertes_3) + nrow(muertes_4)) ## Muertes
# print(nrow(muertes_2) + nrow(muertes_3) + nrow(muertes_4)) #Muertes en cama
# print(nrow(visitas))
# print(nrow(dat))
dat[1,index] <- dat[1,index] + nrow(atendidos)
dat[2,index] <- dat[2,index] + nrow(curados)
dat[3,index] <- dat[3,index] + nrow(muertes_1)
dat[4,index] <- dat[4,index] + nrow(muertes_2)
dat[5,index] <- dat[5,index] + nrow(muertes_3)
dat[6,index] <- dat[6,index] + nrow(muertes_4)
dat[7,index] <- dat[7,index] + nrow(visitas)
dat[8,index] <- dat[8,index] + mean_activity_time
#return(dat)
###################### FIN RECOLECCIÓN DE DATOS
######## Creación del fichero log.csv
ciclos <- day_number * 480
dataframe <- matrix(nrow = ciclos, ncol = 2000)
dataframe[is.na(dataframe)] <- 0
#pacientes <- arrivals$name[grep("^Paciente", arrivals$name)]
pacientes <- atributos %>%
filter(grepl("^Paciente", name)) %>%
distinct(name) %>%
pull(name)
PacientesCols <- 6
PrePacientes <- 4
posCamas <- 4
for (t in 1:ciclos) {
#print(t)
if(t!=1){
dataframe[t,] <- dataframe[t-1,]
} else {
dataframe[t,posCamas] <- beds
}
desp <- 1
dataframe[t][desp] <- t-1
desp <- desp + 1
attributes_at_time <- atributos %>%
filter(time == t) %>%
filter(key != "tiempo_espera_inicio")
if (nrow(attributes_at_time) > 0) {
for (i in 1:nrow(attributes_at_time)) {
evento <- attributes_at_time$key[i]
valor <- attributes_at_time$value[i]
nombre <- attributes_at_time$name[i]
if(evento == "Doctor_descansa"){
if (valor == 1) {
dataframe[t, desp] <- dataframe[t-1, desp] + 1
} else {
dataframe[t, desp] <- dataframe[t-1, desp] - 1
}
} else if (evento == "Enfermera_descansa"){
if (valor == 1) {
dataframe[t, desp + 1] <- dataframe[t-1, desp + 1] + 1
} else {
dataframe[t, desp + 1] <- dataframe[t-1, desp + 1] - 1
}
} else if (evento == "Estado_vital"){
idPac <- gsub("Paciente", "", nombre)
idPac <- as.numeric(idPac)
if (valor == -11) { ## llegada
dataframe[t, PrePacientes + idPac*PacientesCols + 1] <- t-1
dataframe[t, PrePacientes + idPac*PacientesCols + 4] <- valor
} else if (valor == -10) { ## En cama
dataframe[t,posCamas] <- dataframe[t,posCamas] - 1
dataframe[t, PrePacientes + idPac*PacientesCols + 4] <- valor
} else if (valor == -4) { ## Muerte en estado crítico
dataframe[t,posCamas] <- dataframe[t,posCamas] + 1
dataframe[t, PrePacientes + idPac*PacientesCols + 4] <- valor
dataframe[t, PrePacientes + idPac*PacientesCols + 3] <-  t-1 - dataframe[t, PrePacientes + idPac*PacientesCols + 1]
dataframe[t, PrePacientes + idPac*PacientesCols + 6] <- t-1
} else if (valor == -3) { ## Muerte por falta de atención
dataframe[t,posCamas] <- dataframe[t,posCamas] + 1
dataframe[t, PrePacientes + idPac*PacientesCols + 4] <- valor
dataframe[t, PrePacientes + idPac*PacientesCols + 3] <-  t-1 - dataframe[t, PrePacientes + idPac*PacientesCols + 1]
dataframe[t, PrePacientes + idPac*PacientesCols + 6] <- t-1
} else if (valor == -2) { ## Muerte por las consecuencias de la operación
dataframe[t,posCamas] <- dataframe[t,posCamas] + 1
dataframe[t, PrePacientes + idPac*PacientesCols + 4] <- valor
dataframe[t, PrePacientes + idPac*PacientesCols + 3] <-  t-1 - dataframe[t, PrePacientes + idPac*PacientesCols + 1]
dataframe[t, PrePacientes + idPac*PacientesCols + 6] <- t-1
} else if (valor == -1) { ## Muerte por camas insuficientes
dataframe[t, PrePacientes + idPac*PacientesCols + 4] <- valor
dataframe[t, PrePacientes + idPac*PacientesCols + 6] <- t-1
} else if (valor == 1) { ## Cuidados criticos
dataframe[t, PrePacientes + idPac*PacientesCols + 4] <- valor
} else if (valor == 2) { ## Cuidados especiales
dataframe[t, PrePacientes + idPac*PacientesCols + 4] <- valor
} else if (valor == 3) { ## Intervención quirúrgica
dataframe[t, PrePacientes + idPac*PacientesCols + 4] <- valor
} else if (valor == 4) { ## Cuidados básicos
dataframe[t, PrePacientes + idPac*PacientesCols + 4] <- valor
} else if (valor == 5) { ## Alta
dataframe[t,posCamas] <- dataframe[t,posCamas] + 1
dataframe[t, PrePacientes + idPac*PacientesCols + 4] <- valor
dataframe[t, PrePacientes + idPac*PacientesCols + 3] <-  t-1 - dataframe[t, PrePacientes + idPac*PacientesCols + 1]
dataframe[t, PrePacientes + idPac*PacientesCols + 6] <- t-1
}
} else if (evento == "recibe_visita"){
idPac <- gsub("Paciente", "", nombre)
idPac <- as.numeric(idPac)
if (valor == 1) { ## visita
dataframe[t, PrePacientes + idPac*PacientesCols + 5] <- valor
} else { ## No visita
dataframe[t, PrePacientes + idPac*PacientesCols + 5] <- valor
}
}  else if (evento == "tiempo_espera"){
idPac <- gsub("Paciente", "", nombre)
idPac <- as.numeric(idPac)
dataframe[t, PrePacientes + idPac*PacientesCols + 2] <- valor + dataframe[t, PrePacientes + idPac*PacientesCols + 2]
}
}
}
}
# if (nrow(attributes_at_time) > 0) {
#   cat("Atributos cambiados en el tiempo", t, ":\n")
#   print(attributes_at_time)
# } else {
#   cat("No hay cambios en los atributos en el tiempo", t, "\n")
# }
dataframe <- as.data.frame(dataframe)
colN <- c()
i <- 0
colN <- append(colN,"tiempo de simulacion")
colN <- append(colN,"Descansos doctores")
colN <- append(colN,"Descansos enfermeras")
colN <- append(colN,"Camas disponibles")
while (i < length(pacientes)) {
colN <- append(colN,sprintf("p%d llegada", i))
colN <- append(colN,sprintf("p%d tiempo ultima espera", i))
colN <- append(colN,sprintf("p%d tiempo ingresado", i))
colN <- append(colN,sprintf("p%d estado vital", i))
colN <- append(colN,sprintf("p%d recibe visita", i))
colN <- append(colN,sprintf("p%d tiempo salida", i))
i <- i+1
}
colnames(dataframe) <- colN
write.csv2( dataframe, "log.csv", row.names = FALSE)
print("FIN")
######## FIN Creación fichero log.csv
}
## Obtener la información de los recursos
# recursos <- get_mon_resources(modelo)
# Mostrar las variables de estado
# plot(recursos, metric="usage", items = c("queue", "server"), steps=TRUE)
# Mostrar la utilización de cada recurso
# plot(recursos, metric="utilization",c("Sala de espera", "Camas"))
# Obtener la información de las entidades
# entidades <- get_mon_arrivals(modelo)
# entidades
#
# atributos <- get_mon_attributes(modelo)
# atributos
#
# modelo %>%
#   get_mon_attributes() %>%
#   filter(key == "Curado" & value == 1) %>%
#   summarise(count = n())
#
# curados <- modelo %>%
#   get_mon_attributes() %>%
#   filter(key == "Curado" & value == 1)
#
# curados_ids <- curados %>%
#   select(name) %>%
#   distinct()
#
# curados_activity_time <- curados %>%
#   select(name) %>%
#   distinct() %>%
#   inner_join(entidades, by = c("name" = "name"))
#
# # Mostrar los IDs de los pacientes curados y sus tiempos de actividad
# curados_activity_time <- curados_activity_time %>%
#   select(name, activity_time)
#
# print(curados_activity_time)
# mean_activity_time <- curados_activity_time %>%
#   summarise(mean_time = mean(activity_time))
#
# print(mean_activity_time)
#print(curados_ids)
#print(entidades)
# mean <- 0
# for (seed in 1:200) {
#   mean <- mean + run_simulation(seed, 31, 8, 15)
# }
# mean <- mean/200
#
# print(mean)
# dat <- matrix(0, nrow = 8, ncol = 36)
# cc <- c(8,16,24,32,40,48)
# dd <- c(4,8,12,16,20,24)
# ee <- c(5,10,15,20,25,30)
# for (docNum in 1:length(dd)) {
#   for (camNum in 1:length(cc)) {
#     for (seed in 1:100){
#       print(seed)
#       print(camNum)
#       print(docNum)
#       dat <- run_simulation(seed, 28, dd[docNum], ee[docNum], cc[camNum], camNum + (docNum-1)*length(cc), dat)
#     }
#   }
# }
# dat <- dat/100
#
# dat <- as.data.frame(dat)
# print(dat)
# rownames(dat) <- c("Atendidos","Curados","M camas", "M operacion", "M desatendidos", "M criticos", "visitas", "tiempo estancia curados")
# colN <- c()
# for (docNum in 1:length(dd)) {
#   for (camNum in cc) {
#     colN <- append(colN, sprintf("c%d d%d e%d", camNum, dd[docNum],ee[docNum]))
#   }
# }
# colnames(dat) <- colN
#
# write.csv2( dat, "means.csv")
dat <- matrix(0, nrow = 8, ncol = 5)
run_simulation(1, 28, 10, 10, 20, 1, dat)
